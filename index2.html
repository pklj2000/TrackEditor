<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="utf-8" />
    <!--<link rel="icon" href="%PUBLIC_URL%/favicon.ico" />-->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="Web site created using create-react-app" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
        integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>


    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <title>Mapa</title>
</head>

<body>
    <style>
        #map {
            width: 100%;
            height: 400px;
            border: 1px;
        }
    </style>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <h1>My Track Maker</h1>
    <div id="mapnavbar">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Arquivo
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="#" id="abrirArquivo">Abrir</a>
                            <a class="dropdown-item" href="#" id="fecharArquivo">Fechar</a>
                            <a class="dropdown-item" href="#">Salvar</a>
                            <a class="dropdown-item" href="#">Salvar Como</a>
                            <a class="dropdown-item" href="#">Exportar KML</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Editar
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="#" id="excluirPonto">Excluir Ponto</a>
                            <a class="dropdown-item" href="#" id="excluirTrilha">Excluir Trilha</a>
                        </div>
                    </li>
                </ul>

            </div>
        </nav>
    </div>


    <div id="map"></div>
    <input id="fileAbrir" type="file" id="input" multiple />


    <script>
        var tracks = [];
        var track = [[-20.6260420, -46.4996180]];
        var selectedPoint = [];
        var cores = ['yellow', 'red', 'blue', 'black', 'gray', 'cian', 'brown'];

        var map = L.map('map', {
            zoomControl: false,
            drawControl: true
        }).setView([51.505, -0.09], 13);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        //coloca os bot√µes de zoom do lado direito
        L.control.zoom({
            position: 'topright'
        }).addTo(map);

        //var markersLayer = new L.LayerGroup();
        var editableLayers = new L.FeatureGroup();
        map.addLayer(editableLayers);


        var MyCustomMarker = L.Icon.extend({
            options: {
                shadowUrl: null,
                iconAnchor: new L.Point(12, 12),
                iconSize: new L.Point(24, 24),
                iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/6/6b/Information_icon4_orange.svg'
            }
        });

        var drawPluginOptions = {
            position: 'topright',
            draw: {
                polyline: false,
                polygon: false,
                circle: false, // Turns off this drawing tool
                rectangle: false,
                circlemarker: false,
                marker: {
                    title: "soyel1",
                    icon: new MyCustomMarker()
                }
            },
            edit: {
                featureGroup: editableLayers, //REQUIRED!!
                remove: false
            }
        };

        var drawControl = new L.Control.Draw(drawPluginOptions);
        map.addControl(drawControl);

        function circleClick(e) {
            if (e.target.options.isSelected) {
                e.target.setStyle({ color: "red", isSelected: false });
                selectedPoint = selectedPoint.filter(function (value, index, array) {
                    return value[0] != e.target.options.track || value[1] != e.target.options.index;
                });
            } else {
                e.target.setStyle({ color: "black", isSelected: true });
                selectedPoint.push([e.target.options.track, e.target.options.index]);
            }
            console.log(selectedPoint);

            // console.log(e.ourceTarget.options.index);
        }

        function CarregarMapaTodos() {
            markersLayer.clearLayers();
            tracks.forEach(function (track, index) {
                CarregarMapa(track, cores[index]);
            });
        }

        function CarregarMapa(_track, color) {

            if (_track.length == 0) return;

            var polygon = L.polyline(_track).addTo(markersLayer);
            var point;
            for (var j = 0; j <= _track.length - 1; j++) {
                point = L.circle(_track[j], {
                    color: color ?? 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.5,
                    radius: 1,
                    index: j,
                    track: tracks.length - 1,
                    isSelected: false
                });

                point.on("click", circleClick);
                point.addTo(markersLayer);
            }
            markersLayer.addTo(map);

        }

        function FecharArquivos() {
            tracks = [];
            track = [];
            markersLayer.clearLayers();
        }

        function ExcluirPonto() {
            if (!selectedPoint) return;

            selectedPoint.forEach(function (element, index) {
                const itensToBeMoved = tracks[element[0]].splice(element[1], Infinity);
                itensToBeMoved.pop();
                tracks.push(itensToBeMoved);
            });
            selectedPoint = [];
            CarregarMapaTodos();
        }

        function ExcluirTrilha() {
            if (!selectedPoint) return;

            selectedPoint.forEach(function (element, index) {
                tracks.splice(element[0], 1);
            });
            selectedPoint = [];
            CarregarMapaTodos();
        }

        $(document).ready(function () {
            $("#abrirArquivo").click(function () {
                $("#fileAbrir").click();
            });
        });

    </script>
</body>

</html>