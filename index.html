<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="utf-8" />
    <!--<link rel="icon" href="%PUBLIC_URL%/favicon.ico" />-->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="Web site created using create-react-app" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
        integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>


    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="GpxHelper.js"></script>
    <script src="KmlHelper.js"></script>
    <title>Mapa</title>
</head>

<body>
    <style>
        #map {
            width: 100%;
            height: 400px;
            border: 1px;
        }

        .text-lista {
            font-size: 0.75em;
        }

        @media screen and (max-width: 600px) {
            .column {
                width: 100%;
            }
        }
    </style>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="mapnavbar">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="#">My TrackMaker</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Arquivo
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="#" id="abrirArquivo">Abrir</a>
                            <a class="dropdown-item" href="#" id="fecharArquivo">Fechar</a>
                            <a class="dropdown-item" href="#">Salvar</a>
                            <a class="dropdown-item" href="#" id="exportarArquivo">Exportar GPX</a>
                            <a class="dropdown-item" href="#" id="exportarKml">Exportar KML</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Editar
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="#" id="excluirPonto">Excluir Ponto</a>
                            <a class="dropdown-item" href="#" id="excluirTrilha">Excluir Trilha</a>
                            <a class="dropdown-item" href="#" id="reduzirTrilha">Reduzir Trilha</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Exibir
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="#" id="exibirDadosTrilha">Dados das Trilhas</a>
                        </div>
                    </li>
                </ul>

            </div>
        </nav>
    </div>
    <div class="btn-toolbar mb-3" role="toolbar" aria-label="Toolbar with button groups">
        <div class="btn-group mr-2" role="group" aria-label="First group">
            <button type="button" class="btn btn-outline-secondary btnedit0" sel="false" id="btnEdit"><i
                    class="bi bi-pencil"></i></button>
            <button type="button" class="btn btn-outline-secondary btnedit1" tool="cursor"><i
                    class="bi bi-cursor"></i></button>
            <button type="button" class="btn btn-outline-secondary btnedit1" tool="line"><i
                    class="bi bi-dash"></i></button>
            <button type="button" class="btn btn-outline-secondary btnedit1" tool="point"><i
                    class="bi bi-pin"></i></button>
            <button type="button" class="btn btn-outline-secondary btnedit1" tool="excluirPonto"><i
                    class="bi bi-x-circle"></i></button>
            <button type="button" class="btn btn-outline-secondary btnedit1" tool="excluirTrilha"><i
                    class="bi bi-x-circle-fill"></i></button>
        </div>
        <div class="btn-group mr-2" role="group" id="divButtonConfirm" style="display:none">
            <button type="button" class="btn btn-outline-secondary btnedit1" id="btnSave"><i
                    class="bi bi-check"></i></button>
            <button type="button" class="btn btn-outline-secondary btnedit1" id="btnCancel"><i
                    class="bi bi-x"></i></button>
        </div>
    </div>

    <div id="divMain" class="container-fluid">
        <div class="row">
            <div id="divDadosTrilha" class="col-md-3 col-lg-2 sidebar">
                <ul class="nav flex-column" id="listaTrilhas">
                    <li class="text-lista sidebar-heading d-flex">Trilha 1</span>
                    <li class="text-lista sidebar-heading d-flex">Trilha 2</span>
                </ul>
            </div>
            <main id="divMapa" class="col-md-9 col-lg-10 ms-sm-auto">
                <div id="map"></div>
        </div>
    </div>
    </div>

    <input id="fileAbrir" type="file" id="input" multiple />

    <div class="modal fade" id="modalConfirm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background-color: lightgray;">
                    <span id="modalConfirmTitle">Confirmação?</span>
                </div>
                <div class="modal-body">
                    <span id="modalConfirmMessage">Confirma a operação?</span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                    <a class="btn btn-success btn-ok" id="modalConfirmOK" data-dismiss="modal">Confirmar</a>
                </div>
            </div>
        </div>
    </div>


    <script>
        var tracks = [];
        var track = {};
        var selectedPoint = [];
        var cores = ['yellow', 'red', 'blue', 'black', 'gray', 'cian', 'brown'];
        var selectedEditTool = "";
        var isEditing = false;
        var newTrack = { isReverse: false, isAdd: true, isPreventMapClick: false, points: [], "color": "", relatedTrack: [] };
        var currentView
        var bounds = {minLat:0, minLng:0, maxLat:0, maxLng:0, inicializado:false}

        var map = L.map('map', {
            zoomControl: false,
            drawControl: false
        }).setView([51.505, -0.09], 13);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        L.control.scale().addTo(map);

        //coloca os botões de zoom do lado direito
        L.control.zoom({
            position: 'topright'
        }).addTo(map);

        //var markersLayer = new L.LayerGroup();
        var editableLayers = new L.FeatureGroup();
        map.addLayer(editableLayers);

        var newLineLayer;

        map.on('click', function (e) {
            MapaClick(e);
        });

        const inputElement = document.getElementById("fileAbrir");
        inputElement.addEventListener("change", AbrirArquivos, false);
        inputElement.style.display = "none";

        document.getElementById("fecharArquivo").addEventListener("click", FecharArquivos, false);
        document.getElementById("excluirPonto").addEventListener("click", ExcluirPonto, false);
        document.getElementById("excluirTrilha").addEventListener("click", ExcluirTrilha, false);
        document.getElementById("btnEdit").addEventListener("click", EditarTrilha, false);
        document.getElementById("btnCancel").addEventListener("click", CancelarEdicao, false);
        document.getElementById("btnSave").addEventListener("click", SalvarEdicao, false);
        document.getElementById("exportarArquivo").addEventListener("click", ExportarArquivo, false);
        document.getElementById("exportarKml").addEventListener("click", ExportarKml, false);
        document.getElementById("reduzirTrilha").addEventListener("click", ReduzirTrilha, false);
        document.getElementById("exibirDadosTrilha").addEventListener("click", ExibirDadosTrilha, false);
        var btnedit1 = document.getElementsByClassName("btnedit1");
        Array.from(btnedit1).forEach(function (element) {
            element.addEventListener('click', EditarTrilhaFerramenta);
        });

        function AbrirArquivos() {

            const fileList = this.files; /* now you can work with the file list */
            let trackCount = 0;
            for (let i = 0, numFiles = fileList.length; i < numFiles; i++) {
                const file = fileList[i];

                let reader = new FileReader();
                reader.readAsText(file);
                reader.onload = function () {
                    let totalArquivos = 0;
                    parser = new DOMParser();
                    xmlDoc = parser.parseFromString(reader.result, "application/xml");
                    //track = { "isVisible": true, "points": [], "nome": "", "color": "" };

                    if (xmlDoc.getElementsByTagName("gpx").length > 0) {
                        var trks = xmlDoc.getElementsByTagName("trk");

                        totalArquivos += trks.length;
                        for (var k = 0; k < trks.length; k++) {
                            track = { "isVisible": true, "points": [], "nome": "", "color": "" };
                            track.name = (trks[k].getElementsByTagName("name")[0]).textContent;
                            track.color = cores[trackCount];
                            trackCount++;

                            points = trks[k].getElementsByTagName("trkpt");
                            for (j = 0; j < points.length; j++) {
                                track.points.push({
                                    "lat": points[j].getAttribute("lat"),
                                    "lng": points[j].getAttribute("lon"),
                                    "ele": +(points[j].getElementsByTagName("ele")[0]).textContent,
                                    "pointer": null
                                });
                            }
                            tracks.push(track);
                        };
                    }

                    if (xmlDoc.getElementsByTagName("kml").length > 0) {
                        var trks = xmlDoc.getElementsByTagName("Placemark");

                        totalArquivos += trks.length;
                        for (var k = 0; k < trks.length; k++) {
                            track = { "isVisible": true, "points": [], "nome": "", "color": "" };
                            track.name = (trks[k].getElementsByTagName("name")[0]).textContent;
                            track.color = cores[trackCount];
                            trackCount++;

                            var coordenadas = trks[k].getElementsByTagName("coordinates")[0].textContent;
                            var coordenadasArray = coordenadas.split(" ");
                            for (j = 0; j < coordenadasArray.length; j++) {
                                let coord = coordenadasArray[j].replaceAll('\t', '').replaceAll('\n', '').split(",");
                                if (coord.length == 3) {
                                    track.points.push({
                                        "lat": +coord[1],
                                        "lng": +coord[0],
                                        "ele": +coord[2],
                                        "pointer": null
                                    });
                                }
                            }
                            tracks.push(track);
                        }
                    }
                    //if (tracks.length == totalArquivos) CarregarMapaTodos();
                    CarregarMapaTodos();
                    CentralizarMapa();
                };


                reader.onerror = function () {
                    console.log(reader.error);
                };
            }

            inputElement.value = null;
        }

        function circleClick(e) {

            if (selectedEditTool == "line") {
                if (newTrack.points.length > 0) {
                    newTrack.isPreventMapClick = false;
                    let isFirstInTrack = e.target.options.index == 0;
                    let isLastInTrack = tracks[e.target.options.track].points.length - 1 == e.target.options.index;

                    //se é uma trilha com pontos e a pessoa escolher um ponto de outra trilha, perguntar se vai juntar
                    if (isFirstInTrack || isLastInTrack) {
                        newTrack.isPreventMapClick = true;
                        ExibirConfirmacao('Confirmação', 'Confirmar o merge das trilhas?', function () {
                            let i = 0;
                            let j = 0;
                            let trackId = e.target.options.track;
                            while (i < tracks[e.target.options.track].points.length) {
                                j = isFirstInTrack ? i : e.target.options.index - i;
                                let latlng = L.latLng(tracks[trackId].points[j].lat, tracks[trackId].points[j].lng);

                                if (newTrack.index == 0)
                                    newTrack.points.unshift({ "lat": latlng.lat, "lng": latlng.lng, "ele": tracks[trackId].points[j].ele, "pointer": null });
                                else
                                    newTrack.points.push({ "lat": latlng.lat, "lng": latlng.lng, "ele": tracks[trackId].points[j].ele, "pointer": null });

                                //GetNewTrackPolyline().addLatLng(latlng);
                                i++;
                            }
                            tracks.splice(e.target.options.track, 1);
                            //tracks[e.target.options.track].isVisible = false;
                            newTrack.relatedTrack.push(e.target.options.track);

                            CarregarLayerNew();
                            CarregarMapaTodos();

                        });
                    }

                } else {
                    newTrack.isFirstPoint = false;
                    if (e.target.options.index == 0 || e.target.options.index == tracks[e.target.options.track].points.length - 1) {
                        //inicio de uma edição de uma track
                        //incluindo os pontos do track selecionado para newtrack
                        newTrack.points = [...tracks[e.target.options.track].points];
                        newTrack.polyline = tracks[e.target.options.track].polyline;
                        newTrack.color = cores[e.target.options.track];
                        tracks[e.target.options.track].isVisible = false;
                        newTrack.isAdd = false;
                        newTrack.isPreventMapClick = true;

                    } else {
                        newTrack.isAdd = true;
                    }
                    newTrack.trackId = e.target.options.track;
                    newTrack.index = e.target.options.index;
                    newTrack.isReverse = e.target.options.index == tracks[e.target.options.track].points.length - 1;
                    console.log(e.target.options.index + "-" + (tracks[e.target.options.track].points.length - 1) + newTrack.isReverse);
                    return;
                }
            }
            console.log("circleclick");

            /*singleselect*/
            selectedPoint.forEach(function (track, index) {
                var obj = tracks[track[0]].points[track[1]].pointer;
                obj.setStyle({ color: "gray", isSelected: false });
            });

            selectedPoint = Array();
            selectedPoint.push([e.target.options.track, e.target.options.index]);
            e.target.setStyle({ color: "red", isSelected: true });
        }

        function MapaClick(e) {
            if (selectedEditTool == "line") {
                if (newTrack.isPreventMapClick) return;

                if (newTrack.points.length == 0)
                    newTrack.color = newTrack.isAdd ? cores[tracks.length - 1] : cores[newTrack.trackId];

                console.log(e.latlng.lat);
                let latlng = L.latLng(e.latlng.lat, e.latlng.lng);

                point = L.circle(latlng, {
                    color: "gray",
                    fillColor: '#f03',
                    fillOpacity: 0.5,
                    radius: 1,
                    index: newTrack.points.length - 1,
                    track: tracks.length - 1,
                    isSelected: false
                });
                point.on("click", circleClick);
                point.addTo(newLineLayer);

                if (newTrack.isReverse)
                    newTrack.points.unshift({ "lat": e.latlng.lat, "lng": e.latlng.lng, "ele": 0, "pointer": null });
                else
                    newTrack.points.push({ "lat": e.latlng.lat, "lng": e.latlng.lng, "ele": 0, "pointer": null });

                if (newTrack.points.length == 2) {
                    GetNewTrackPolyline();
                }

                if (newTrack.points.length > 2) {
                    CarregarLayerNew();
                    //GetNewTrackPolyline().addLatLng(latlng);
                }

            }
        }

        function GetNewTrackPolyline() {
            if (!newTrack.polyline) {
                let polyline = L.polyline(newTrack.points, { color: newTrack.color }).addTo(newLineLayer);
                newTrack.polyline = polyline;
            }
            return newTrack.polyline;
        }

        function CarregarLayerNew() {
            newLineLayer.remove();

            newLineLayer = new L.FeatureGroup();
            map.addLayer(newLineLayer);

            var polyline = L.polyline(newTrack.points, { color: newTrack.color }).addTo(newLineLayer);
            newTrack.polyline = polyline;
        }


        function CarregarMapaTodos() {
            var _zoom = map.getZoom();
            var _lat = map.getCenter().lat;
            var _lng = map.getCenter().lng;

            editableLayers.clearLayers();

            tracks.forEach(function (track, index) {
                if (track.isVisible) CarregarMapa(track, index, cores[index], (tracks.length - 1 == index));
            });
            CarregarListaTrilhas();

            map.setView([_lat, _lng], _zoom);
            selectedPoint = [];
        }

        function CarregarListaTrilhas() {
            $("#listaTrilhas").html("");
            tracks.forEach(function (track, index) {
                $("#listaTrilhas").append(`<li class='text-lista sidebar-heading d-flex row'><div class='col-md-8'>${track.name}</div>
                    <div class='col-md-2'><i class="bi bi-dash-square-fill" style='color:${track.color};'></i></div>
                    <div class='col-md-2'><i class="${track.isVisible ? 'bi bi-eye' : 'bi bi-eye-slash'}" style='color:black;'></i></div>
                    </li>`);
            });
        }

        function CarregarMapa(track, index, color, setView) {

            if (track.points.length == 0) return;
            if (!track.isVisible) return;

            var polyline = L.polyline(track.points, { color: color ?? 'red' }).addTo(editableLayers);
            var point;
            if (isEditing) {
                for (var j = 0; j <= track.points.length - 1; j++) {
                    var latlng = L.latLng(track.points[j].lat, track.points[j].lng);
                    point = L.circle(latlng, {
                        color: "gray",
                        fillColor: '#f03',
                        fillOpacity: 0.5,
                        radius: 1,
                        index: j,
                        track: index,
                        isSelected: false
                    });

                    point.on("click", circleClick);
                    point.addTo(editableLayers);
                    track.points[j].pointer = point;
                    track.polyline = polyline;
                }
            }
            
            editableLayers.addTo(map);

            if (setView) map.fitBounds(polyline.getBounds());

        }

        function CentralizarMapa(){
            console.log("CentralizarMapa", tracks.length);
            for (var i = 0; i<= tracks.length -1; i++){
                for(var j = 0; j <= tracks[i].points.length-1; j++){
                    if (!bounds.inicializado || bounds.minLat > tracks[i].points[j].lat) bounds.minLat = tracks[i].points[j].lat;
                    if (!bounds.inicializado || bounds.minLng > tracks[i].points[j].lng) bounds.minLng = tracks[i].points[j].lng;
                    if (!bounds.inicializado || bounds.maxLat < tracks[i].points[j].lat) bounds.maxLat = tracks[i].points[j].lat;
                    if (!bounds.inicializado || bounds.maxLng < tracks[i].points[j].lng) bounds.maxLng = tracks[i].points[j].lng;
                    bounds.inicializado = true;
                }
            }
            

            let c1 = L.latLng(bounds.minLat, bounds.minLng);
            let c2 = L.latLng(bounds.maxLat , bounds.maxLng );
            map.fitBounds(L.latLngBounds(c1, c2));

        }

        function FecharArquivos() {
            tracks = [];
            track = [];
            selectedPoint = [];
            editableLayers.clearLayers();
            CarregarMapaTodos();
        }

        function ExcluirPonto() {
            if (!selectedPoint) return;

            selectedPoint.forEach(function (element, index) {
                const itensToBeMoved = tracks[element[0]].points.splice(element[1], Infinity);
                itensToBeMoved.pop();
                tracks.push({ "isVisible": true, "points": itensToBeMoved });
            });
            selectedPoint = [];
            CarregarMapaTodos();
        }

        function ExcluirTrilha() {
            if (!selectedPoint) return;

            selectedPoint.forEach(function (element, index) {
                tracks.splice(element[0], 1);
            });
            selectedPoint = [];
            CarregarMapaTodos();
        }

        function EditarTrilha() {

            var selected = $("#btnEdit").attr("sel") == 'false';
            $("#btnEdit").attr("sel", selected);
            if (selected) {
                $("#btnEdit").removeClass("btn-outline-secondary").addClass("btn-secondary");
                $(".btnedit1").show();
                isEditing = true;
            }
            else {
                $("#btnEdit").removeClass("btn-secondary").addClass("btn-outline-secondary");
                $(".btnedit1").hide();
                $("#divButtonConfirm").hide();
                selectedEditTool = "";
                isEditing = false;
            }
            CarregarMapaTodos();
        }

        function EditarTrilhaFerramenta() {
            $("#divButtonConfirm").hide();
            selectedEditTool = $(this).attr("tool")

            $("button.btnedit1").removeClass("btn-secondary").addClass("btn-outline-secondary");
            $(`button[tool='${selectedEditTool}']`).removeClass("btn-outline-secondary").addClass("btn-secondary");

            if (selectedEditTool == "line") {
                $("#divButtonConfirm").show();
                $("button[tool='line']").removeClass("btn-outline-secondary").addClass("btn-secondary");

                newLineLayer = new L.FeatureGroup();
                map.addLayer(newLineLayer);
                selectedPoint = [];
                return;
            }


            if (selectedEditTool == "excluirPonto") ExcluirPonto();
            if (selectedEditTool == "excluirTrilha") ExcluirTrilha();
            if (selectedEditTool != "line") newTrack.points = [];

        }


        function CancelarEdicao() {
            $("#divButtonConfirm").hide();

            newTrack.relatedTrack.forEach(function (item, index) {
                tracks[item].isVisible = true;
            });

            newTrack = { isReverse: false, isAdd: true, track: [], "color": "", relatedTrack: [] };
            newLineLayer.remove();

            $("#btnEdit").attr("sel") == 'false';
            EditarTrilha();
            CarregarMapaTodos();
        }

        function SalvarEdicao() {
            tracks.push({ "isVisible": true, "points": newTrack.points });
            $("#btnEdit").attr("sel") == 'false';
            EditarTrilha();
            CarregarMapaTodos();
        }

        function ExibirConfirmacao(title, message, callback) {
            $("#modalConfirm").modal("show");
            $("#modalConfirmTitle").text(title);
            $("#modalConfirmMessage").text(message);
            if (callback) $("#modalConfirmOK").click(callback);
        }

        function ExportarArquivo() {
            var data = new Date(); 

            //gerando tracks
            var gpx = new GpxHelper("teste");
            gpx.AddTrackHeader()
            tracks.forEach(function (track, index) {
                if (track.isVisible && track.points.length > 0) {
                    gpx.AddTrackHeader(`trk${index}`, index);

                    track.points.forEach(function (point, index) {
                        gpx.AddTrackPoint(point.lat, point.lng, point.ele);
                    });
                }
                gpx.AddTrackFooter();
            });
            download(`gpx${data.getFullYear()}${data.getMonth()+1}${data.getDay()}${data.getHours()}${data.getMinutes()}${data.getSeconds()}.gpx`, gpx.GetGpx());
        }

        function ExportarKml() {
            var kml = new KmlHelper("teste");

            tracks.forEach(function (track, index) {
                if (track.isVisible && track.points.length > 0) {
                    kml.AddTrackHeader(`trk${index}`);

                    track.points.forEach(function (point, index2) {
                        kml.AddTrackPoint(point.lat, point.lng, point.ele);
                    });
                    kml.AddTrackFooter();
                }

            });
            kml.AddEndDocument();
            download("teste.kml", kml.GetKml());
        }

        function ReduzirTrilha() {
            const distanciaReferencia = 50;

            if (!selectedPoint) return;
            if (selectedPoint.length == 0) return;
            console.log(selectedPoint);

            let trackIndex = selectedPoint[0][0];
            let lat0;
            let lng0;
            let distancia = 0;
            let newTrack = [];

            let latT;
            let lngT;
            let distanciaTotal = 0;

            console.log("ReduzirTrilha");
            console.log(tracks[trackIndex].points.length);

            tracks[trackIndex].points.forEach(function (item, index) {
                if (index > 0) {
                    distancia += getDistanceFromLatLonInM(lat0, lng0, item.lat, item.lng);
                    distanciaTotal += getDistanceFromLatLonInM(latT, lngT, item.lat, item.lng);
                    console.log(distancia);
                    if (distancia > distanciaReferencia) {
                        newTrack.push(item);
                        lat0 = item.lat;
                        lng0 = item.lng;
                        distancia = 0;
                    }
                } else {
                    newTrack.push(item);
                    lat0 = item.lat;
                    lng0 = item.lng;
                }
                latT = item.lat;
                lngT = item.lng;

            });

            tracks[trackIndex].points = newTrack;

            selectedPoint = [];
            CarregarMapaTodos();
        }

        function ExibirDadosTrilha() {
            $("#divDadosTrilha").toggle();
            if ($("#divDadosTrilha").is(":visible")) {
                $("#divMapa").addClass("col-md-9 col-lg-10").removeClass("col-md-12 col-lg-12");
                //$("#divDadosTrilha").addClass("col-md-3 col-lg-2").removeClass("column30");
            } else {
                $("#divMapa").addClass("col-md-12 col-lg-12").removeClass("col-md-9 col-lg-10");
                //$("#divDadosTrilha").addClass("column30").removeClass("column0");
            }
        }


        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(lat2 - lat1);  // deg2rad below
            var dLon = deg2rad(lon2 - lon1);
            var a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2)
                ;
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c * 1000; // Distance in m
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180)
        }

        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

        $(document).ready(function () {
            $("#abrirArquivo").click(function () {
                $("#fileAbrir").click();
            });

            $(".btnedit1").hide();
        });

    </script>
</body>

</html>